---
title: 群晖反向代理
date: 2025-03-24
isOriginal: true
category:
  - 工具箱
tag:
  - 群晖
  - 反向代理
editLink: false
footer: false
copy: true
---

在使用群晖配置反向代理之前，首先了解下服务配置，以及服务访问

例如：域名`api.example.com`api服务和`docs.example.com`文档服务

|主机地址|服务|协议|Docker端口|Host端口|路由器端口|域名|
|:-|:-|:-|:-|:-|:-|:-|
|192.168.1.255|文档服务|http|80|81|82|docs.example.com|
|192.168.1.255|api服务|http|88|89|90|api.example.com|

## 本地访问

文档服务Docker部署，Docker内部端口默认80，暴露在主机上映射的端口为`81`，在主机上防火墙规则将`81`端口放开，在局域网内可以通过`192.168.1.255:81`即可访问文档服务。

## 外网访问

如果想外网访问文档服务，前提需要公网IP（动态，固定），然后在路由器端口映射，将`192.168.1.255`的`81`端口暴露出来，例如这里将内网的`81`端口映射为外网的`82`端口，通过浏览器访问`192.168.1.255`对应的`公网IP:82`即可访问文档服务。

## 域名

因为公网IP有动态（免费）和固定两种，为了方便记忆，就使用域名代替实际的公网IP，域名配置[参考这里](domain.md)，例如这里申请了一个`example.com`域名，即可通过`example.com:82`访问文档服务，同理`example.com:90`访问API服务

这里为止，服务访问一切正常，更进一步的会发现，如果有N多的服务，那么就需要N多的端口，每个服务对应一个端口。

浏览器默认`http:example.com:80`和`https:example.com:443`是最重要的两个端口，访问时根据协议默认添加对应的`80`或`443`端口，浏览器上不会显示，但其他端口需要指定。特别是`443`，一台主机只有一个`443`端口，如果N多服务都要使用`443`端口，那么就需要N台主机，每个主机对应一个域名服务以及443端口。如果在一台主机上，N多服务就只有一个服务可以使用`443`端口。

这时就有反向代理这种技术，可以解决N多服务都使用同一个`443`端口。

## 反向代理

如上所说，N多服务用一个`443`端口，那么如何区分访问的是具体哪一个服务，在不共用一个端口之前，是域名固定，端口区分。现在反之，端口固定，域名区分，即`api.example.com:443`访问的是api服务，`docs.example.com:443`访问的是文档服务。

以群晖反向代理配置为例

1. 一级域名`example.com`在DDNS配置好公网IP
2. 申请二级域名`docs.example.com`，导出`nginx`证书
3. 打开`门户登录\高级\反向代理服务器`
4. 新增一个配置
   1. 来源
      1. 协议：选择`https`
      2. 主机名：填写二级域名，如`docs.example.com`
      3. 端口：填写`443`或者其他端口
      4. 启用HSTS，`勾选`
   2. 目的地
      1. 协议：选择`http`
      2. 主机名：填写主机地址，如`192.168.1.255`
      3. 端口：填写主机暴露端口，如`81`
5. 打开`安全性\证书\新增`，导入配置的方向代理规则对应的证书`docs.example.com`
6. 打开`安全性\证书\设置`，将配置的反向代理`docs.exmaple.com:443`规则，选择对应的`docs.example.com`证书即可

配置反向代理之前，通过`example.com:82`或`api.example.com:82`访问API服务，`example.com:90`或`docs.example.com:90`访问文档服务

配置反向代理之后，通过`api.example.com:80`访问API服务，`docs.example.com:80`访问文档服务

::: tip
目的地协议选择`http`还是`https`取决于本身服务提供的协议，在没有反向代理时，如设置了`ssl`并可以通过`https://docs.example.com:90`访问，即选`https`
:::


## 其他

在动态公网IP`80`和`443`端口被封的情况下，可以在反向代理上配置一条域名的两个访问端口，一个`443`一个其他端口，虽然通过外网在无法不输入`443`端口的情况直接访问，但是在局域网内可以，外网则通过输入另外一个端口访问即可。

没有配置反向代理之前，可以一个域名，多个端口访问，缺点在于记住每个端口

配置反向代理之后，可以多个域名，一个端口访问，缺点在于费域名，特别在于现在`ssl`证书只有3个月，厂商提供的免费证书有限。可以通过[Let's Encrypt](https://letsencrypt.org/zh-cn/)申请泛域名证书



